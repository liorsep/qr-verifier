<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Independence 2025 - QR Scanner & Verifier</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      text-align: center; 
      margin-top: 30px; 
      background: linear-gradient(to bottom right, #4facfe, #00f2fe);
      color: white;
      min-height: 100vh;
      background-attachment: fixed;
      overflow-x: hidden;
    }
    #reader { background: white; padding: 10px; border-radius: 10px; }
    #result { margin-top: 20px; font-size: 1.5em; }
    .approved { color: #00ff00; }
    .rejected { color: #ff4c4c; }
    #approve-btn, #reset-btn { margin-top: 20px; padding: 10px 20px; font-size: 1.2em; display: none; border: none; border-radius: 5px; }
    #approve-btn { background-color: #28a745; color: white; animation: pulse 1s infinite alternate; }
    #reset-btn { background-color: red; color: white; }
    h1 { font-size: 2.5em; margin-bottom: 10px; }
    h2 { font-size: 1.2em; margin-top: 0; }

    /* Floating flags */
    .flag {
      position: absolute;
      top: -50px;
      font-size: 30px;
      animation: fall linear infinite;
      opacity: 0.8;
    }

    @keyframes fall {
      0% { transform: translateY(-100px) translateX(0); }
      100% { transform: translateY(110vh) translateX(50px); }
    }

    /* Approve button pulse effect */
    @keyframes pulse {
      0% { transform: scale(1); }
      100% { transform: scale(1.05); }
    }
  </style>
</head>
<body>
  <h1>ðŸ‡®ðŸ‡± Independence 2025 ðŸ‡®ðŸ‡±</h1>
  <h2>QR Scanner & Verifier</h2>

  <div id="reader" style="width: 300px; margin: auto;"></div>
  <div id="result"></div>
  <div id="person-name" style="margin-top: 10px; font-size: 1.2em;"></div>

  <button id="approve-btn">Approve</button>
  <br>
  <button id="reset-btn">Reset Scans</button>

  <!-- Floating flags -->
  <div class="flag" style="left: 10%; animation-duration: 10s;">ðŸ‡®ðŸ‡±</div>
  <div class="flag" style="left: 30%; animation-duration: 12s;">ðŸ‡®ðŸ‡±</div>
  <div class="flag" style="left: 50%; animation-duration: 14s;">ðŸ‡®ðŸ‡±</div>
  <div class="flag" style="left: 70%; animation-duration: 11s;">ðŸ‡®ðŸ‡±</div>
  <div class="flag" style="left: 90%; animation-duration: 13s;">ðŸ‡®ðŸ‡±</div>

  <script>
    let validHashes = [];
    let scannedHashes = JSON.parse(localStorage.getItem('scannedHashes') || '[]');
    let currentScannedHash = null;
    let currentScannedName = "";

    // Load the valid hashes with names
    fetch('hashes_with_names.json')
      .then(response => response.json())
      .then(data => {
        validHashes = data;
        document.getElementById('reset-btn').style.display = 'inline-block';
      })
      .catch(err => {
        document.getElementById('result').innerHTML = '<span class="rejected">Failed to load hashes.</span>';
      });

    function findNameByHash(hash) {
      const entry = validHashes.find(item => item.hash === hash);
      return entry ? entry.name : null;
    }

    function onScanSuccess(decodedText) {
      if (decodedText.startsWith('hash=')) {
        const scannedHash = decodedText.replace('hash=', '').trim();

        const name = findNameByHash(scannedHash);

        if (!name) {
          document.getElementById('result').innerHTML = '<span class="rejected">Invalid QR Code.</span>';
          document.getElementById('approve-btn').style.display = 'none';
          document.getElementById('person-name').innerText = "";
        } else if (scannedHashes.includes(scannedHash)) {
          document.getElementById('result').innerHTML = '<span class="rejected">Already Scanned.</span>';
          document.getElementById('approve-btn').style.display = 'none';
          document.getElementById('person-name').innerText = name;
        } else {
          currentScannedHash = scannedHash;
          currentScannedName = name;
          document.getElementById('result').innerHTML = '<span class="approved">Valid QR! Please click Approve.</span>';
          document.getElementById('approve-btn').style.display = 'inline-block';
          document.getElementById('person-name').innerText = `Name: ${name}`;
        }
      } else {
        document.getElementById('result').innerHTML = '<span class="rejected">Invalid QR Format.</span>';
        document.getElementById('approve-btn').style.display = 'none';
        document.getElementById('person-name').innerText = "";
      }
    }

    document.getElementById('approve-btn').addEventListener('click', function() {
      if (currentScannedHash) {
        scannedHashes.push(currentScannedHash);
        localStorage.setItem('scannedHashes', JSON.stringify(scannedHashes));
        document.getElementById('result').innerHTML = '<span class="approved">ðŸŽ‰ QR Approved and Saved for ' + currentScannedName + '!</span>';
        document.getElementById('approve-btn').style.display = 'none';
        document.getElementById('person-name').innerText = "";
        currentScannedHash = null;
        currentScannedName = "";
      }
    });

    document.getElementById('reset-btn').addEventListener('click', function() {
      if (confirm('Are you sure you want to reset all scanned QR approvals?')) {
        localStorage.removeItem('scannedHashes');
        scannedHashes = [];
        document.getElementById('result').innerHTML = '<span class="approved">All scanned records have been reset.</span>';
      }
    });

    const html5QrcodeScanner = new Html5QrcodeScanner(
      "reader", { fps: 10, qrbox: 250 });
    html5QrcodeScanner.render(onScanSuccess);
  </script>
</body>
</html>
