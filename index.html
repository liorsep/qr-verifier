<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Independence 2025 - QR Scanner & Verifier</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      text-align: center; 
      margin-top: 30px; 
      background: linear-gradient(to bottom right, #4facfe, #00f2fe);
      color: white;
      min-height: 100vh;
      background-attachment: fixed;
      overflow-x: hidden;
    }
    #reader { background: white; padding: 10px; border-radius: 10px; }
    #result { margin-top: 20px; font-size: 1.5em; }
    .approved { color: #00ff00; }
    .rejected { color: #ff4c4c; }
    #approve-btn, #reset-btn { margin-top: 20px; padding: 10px 20px; font-size: 1.2em; display: none; border: none; border-radius: 5px; }
    #approve-btn { background-color: #28a745; color: white; animation: pulse 1s infinite alternate; }
    #reset-btn { background-color: red; color: white; }
    h1 { font-size: 2.5em; margin-bottom: 10px; }
    h2 { font-size: 1.2em; margin-top: 0; }

    /* Floating flags */
    .flag {
      position: absolute;
      top: -50px;
      font-size: 30px;
      animation: fall linear infinite;
      opacity: 0.8;
    }

    @keyframes fall {
      0% { transform: translateY(-100px) translateX(0); }
      100% { transform: translateY(110vh) translateX(50px); }
    }

    /* Approve button pulse effect */
    @keyframes pulse {
      0% { transform: scale(1); }
      100% { transform: scale(1.05); }
    }
  </style>
</head>
<body>
  <div id="login-form">
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button onclick="handleLogin()">Login</button>
  </div>
  <div id="app-content" style="display:none;">
  <h1>ðŸ‡®ðŸ‡± Independence 2025 ðŸ‡®ðŸ‡±</h1>
  <h2>QR Scanner & Verifier</h2>

  <div id="reader" style="width: 300px; margin: auto;"></div>
  <div id="result"></div>
  <div id="person-name" style="margin-top: 10px; font-size: 1.2em;"></div>

  <button id="approve-btn">Approve</button>
  <br>
  <!-- <button id="reset-btn">Reset Scans</button> -->

  <!-- Floating flags -->
  <div class="flag" style="left: 10%; animation-duration: 10s;">ðŸ‡®ðŸ‡±</div>
  <div class="flag" style="left: 30%; animation-duration: 12s;">ðŸ‡®ðŸ‡±</div>
  <div class="flag" style="left: 50%; animation-duration: 14s;">ðŸ‡®ðŸ‡±</div>
  <div class="flag" style="left: 70%; animation-duration: 11s;">ðŸ‡®ðŸ‡±</div>
  <div class="flag" style="left: 90%; animation-duration: 13s;">ðŸ‡®ðŸ‡±</div>

  <script>
    let validHashes = [];
    let approvedHashes = [];
    let currentScannedName = "";

    // Load the valid hashes with names
    fetch('hashes_with_names.json')
      .then(response => response.json())
      .then(data => {
        validHashes = data;
      })
      .catch(err => {
        document.getElementById('result').innerHTML = '<span class="rejected">Failed to load hashes.</span>';
        console.error('Failed to load valid hashes:', err);
      });

      fetch('https://sheetdb.io/api/v1/d1y4cdqajqw5i') // <--- your SheetDB URL for approvals
        .then(response => response.json())
        .then(data => {
          approvedHashes = data.map(entry => entry.Hash); // assuming you store Hash in the sheet
          document.getElementById('reset-btn').style.display = 'inline-block';
        })
        .catch(err => {
          console.error('Failed to load approved list:', err);
        });

      function findEntryByHash(hash) {
        return validHashes.find(item => item.hash === hash);
      }

      function onScanSuccess(decodedText) {
        if (decodedText.startsWith('hash=')) {
          const scannedHash = decodedText.replace('hash=', '').trim();
          const entry = findEntryByHash(scannedHash); // search in validHashes

          if (!entry) {
            document.getElementById('result').innerHTML = '<span class="rejected">Invalid QR Code.</span>';
            document.getElementById('approve-btn').style.display = 'none';
            document.getElementById('person-name').innerText = "";
          } else if (approvedHashes.includes(scannedHash)) {  // <--- here you check if already approved
            document.getElementById('result').innerHTML = '<span class="rejected">Already Scanned.</span>';
            document.getElementById('approve-btn').style.display = 'none';
            document.getElementById('person-name').innerText = `Name: ${entry.name} | Amount: ${entry.amount}â‚ª`;
          } else {
            currentScannedHash = scannedHash;
            currentScannedName = entry.name;
            document.getElementById('result').innerHTML = '<span class="approved">Valid QR! Please click Approve.</span>';
            document.getElementById('approve-btn').style.display = 'inline-block';
            document.getElementById('person-name').innerText = `Name: ${entry.name} | Amount: ${entry.amount}â‚ª`;
          }

        } else {
          document.getElementById('result').innerHTML = '<span class="rejected">Invalid QR Format.</span>';
          document.getElementById('approve-btn').style.display = 'none';
          document.getElementById('person-name').innerText = "";
        }
      }


    document.getElementById('approve-btn').addEventListener('click', function() {
      document.getElementById('approve-btn').disabled = true;
      if (currentScannedHash) {
        const entry = findEntryByHash(currentScannedHash);
        if (entry) {
          saveApproval(entry.name, entry.phone || '', entry.amount || '', currentScannedHash);
          approvedHashes.push(currentScannedHash); // update the local memory
        }
        document.getElementById('result').innerHTML = '<span class="approved">ðŸŽ‰ QR Approved and Saved for ' + currentScannedName + '!</span>';
        document.getElementById('approve-btn').style.display = 'none';
        document.getElementById('person-name').innerText = "";
        currentScannedHash = null;
        currentScannedName = "";
      }
    });


    // document.getElementById('reset-btn').addEventListener('click', function() {
    //   if (confirm('Reload the app?')) {
    //     location.reload();
    //   }
    // });

    const html5QrcodeScanner = new Html5QrcodeScanner(
      const html5QrCode = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(cameras => {
      if (cameras && cameras.length) {
        html5QrCode.start(
          cameras[0].id,
          { fps: 10, qrbox: 250 },
          onScanSuccess
        );
      }
    }).catch(err => {
      console.error("Camera error:", err);
    });

    // Enable QR image upload
    document.getElementById("reader").insertAdjacentHTML("afterend", `
      <input type="file" id="qr-image" accept="image/*" style="margin-top: 15px;">
    `);

    document.getElementById("qr-image").addEventListener("change", function (e) {
      if (e.target.files.length === 0) return;
      const file = e.target.files[0];
      html5QrCode.scanFile(file, true)
        .then(onScanSuccess)
        .catch(err => {
          document.getElementById('result').innerHTML = '<span class="rejected">Invalid QR Image.</span>';
          console.error("Scan failed:", err);
        });
    });

    function saveApproval(name, number, amount, hash) {
    const data = {
      data: [
        {
          Name: name,
          Phone: number,
          Amount: amount,
          Hash: hash,
          "Approved At": new Date().toISOString()
        }
      ]
    };

    fetch('https://sheetdb.io/api/v1/d1y4cdqajqw5i', { // <-- replace with your real URL
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (response.ok) {
        console.log('Approval saved successfully!');
      } else {
        console.error('Failed to save approval');
      }
    })
    .catch(error => console.error('Error:', error));
  }

  </script>
  </div>
  <script>
    const validUsers = {
    "lior": "partyparty",
    "dror":"partyparty",
    "Lior": "partyparty",
    "Dror":"partyparty"
  };

    function handleLogin() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();

      if (validUsers[username] === password) {
        localStorage.setItem('isLoggedIn', 'true');  // Save login in localStorage
        showApp();
      } else {
        alert('Invalid username or password!');
      }
    }

    function showApp() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('app-content').style.display = 'block';
    }

    function checkLogin() {
      if (localStorage.getItem('isLoggedIn') === 'true') {
        showApp();
      }
    }

    window.onload = checkLogin;
  </script>
</body>
</html>
